<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Race Weekend Preview Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(90deg, #e10600 0%, #ff1e00 100%);
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(225, 6, 0, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .control-panel h2 {
            margin-bottom: 1.5rem;
            color: #e10600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #ccc;
        }

        .input-group input,
        .input-group select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            color: #fff;
            font-size: 1rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #e10600;
        }

        .api-settings {
            background: rgba(225, 6, 0, 0.1);
            border: 1px solid rgba(225, 6, 0, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .api-settings h3 {
            margin-bottom: 1rem;
            color: #ff1e00;
        }

        .generate-btn {
            background: linear-gradient(90deg, #e10600 0%, #ff1e00 100%);
            color: #fff;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(225, 6, 0, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-btn.secondary {
            background: linear-gradient(90deg, #0066cc 0%, #0088ff 100%);
        }

        .generate-btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(0, 102, 204, 0.4);
        }

        .generate-btn.danger {
            background: linear-gradient(90deg, #cc0000 0%, #ff0000 100%);
        }

        .prompt-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 1rem;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            resize: vertical;
            line-height: 1.5;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #e10600;
        }

        .progress-container {
            display: none;
            margin-top: 1.5rem;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, #e10600 0%, #ff1e00 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .progress-text {
            text-align: center;
            color: #ccc;
            font-size: 0.95rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }

        .tab {
            background: transparent;
            border: none;
            color: #999;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            color: #fff;
        }

        .tab.active {
            color: #e10600;
            border-bottom-color: #e10600;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            min-height: 400px;
        }

        .driver-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .driver-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }

        .driver-card:hover {
            background: rgba(225, 6, 0, 0.2);
            border-color: #e10600;
            transform: translateY(-2px);
        }

        .driver-card.generated {
            background: rgba(0, 255, 0, 0.1);
            border-color: rgba(0, 255, 0, 0.3);
        }

        .driver-card.loading {
            background: rgba(255, 165, 0, 0.1);
            border-color: rgba(255, 165, 0, 0.3);
        }

        .driver-card .status-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.2rem;
        }

        .driver-preview {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #e10600;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
        }

        .driver-preview h3 {
            margin-bottom: 1rem;
            color: #e10600;
        }

        .driver-preview .tldr {
            background: rgba(225, 6, 0, 0.1);
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .driver-preview .full-text {
            line-height: 1.6;
            color: #ddd;
        }

        .highlight-section {
            background: linear-gradient(135deg, rgba(225, 6, 0, 0.2) 0%, rgba(255, 30, 0, 0.1) 100%);
            border: 1px solid rgba(225, 6, 0, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .highlight-section h3 {
            color: #ff1e00;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .top-driver-item {
            background: rgba(0, 0, 0, 0.3);
            border-left: 4px solid #e10600;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .top-driver-item h4 {
            margin-bottom: 0.5rem;
        }

        .top-driver-item p {
            color: #ccc;
            line-height: 1.5;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
        }

        .saved-indicator {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.4);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            display: inline-block;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏎️ F1 Race Weekend Preview Generator</h1>
        <p>AI-Powered Driver Analysis & Predictions</p>
    </div>

    <div class="container">
        <div class="control-panel">
            <h2>⚙️ Race Configuration</h2>
            
            <div class="settings-grid">
                <div class="input-group">
                    <label for="circuit">Circuit</label>
                    <select id="circuit">
                        <option value="singapore">Singapore GP - Marina Bay</option>
                        <option value="japan">Japanese GP - Suzuka</option>
                        <option value="qatar">Qatar GP - Losail</option>
                        <option value="usa">United States GP - COTA</option>
                        <option value="mexico">Mexico City GP</option>
                        <option value="brazil">São Paulo GP - Interlagos</option>
                        <option value="vegas">Las Vegas GP</option>
                        <option value="abu-dhabi">Abu Dhabi GP - Yas Marina</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="race-date">Race Weekend Date</label>
                    <input type="date" id="race-date" value="2025-10-05">
                </div>

                <div class="input-group">
                    <label for="season">Season</label>
                    <input type="number" id="season" value="2025" min="2024" max="2030">
                </div>
            </div>

            <div class="api-settings">
                <h3>🔑 OpenAI API Configuration</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label for="api-key">API Key</label>
                        <input type="password" id="api-key" placeholder="sk-...">
                    </div>

                    <div class="input-group">
                        <label for="model">Model</label>
                        <select id="model">
                            <option value="gpt-5">GPT-5</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="temperature">Temperature</label>
                        <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <button class="generate-btn" onclick="generateAllPreviews()">
                    🚀 Generate All Previews
                </button>
                <button class="generate-btn secondary" onclick="togglePromptEditor()">
                    ✏️ Edit Prompts
                </button>
                <button class="generate-btn danger" onclick="clearAllData()">
                    🗑️ Clear Saved Data
                </button>
            </div>

            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill">0%</div>
                </div>
                <div class="progress-text" id="progress-text">Initializing...</div>
            </div>
        </div>

        <div class="control-panel" id="prompt-editor" style="display: none;">
            <h2>✏️ Prompt Editor</h2>
            <p style="color: #ccc; margin-bottom: 1.5rem;">Customize the prompts used for AI generation. Changes are saved automatically to localStorage.</p>
            
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #ff1e00; margin-bottom: 1rem;">Race Context Prompt</h3>
                <textarea id="prompt-race-context" class="prompt-textarea" rows="8"></textarea>
                <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Variables: {circuit}, {raceDate}, {season}</p>
                <div id="saved-race-context" class="saved-indicator" style="display: none;">✓ Saved</div>
            </div>

            <div style="margin-bottom: 2rem;">
                <h3 style="color: #ff1e00; margin-bottom: 1rem;">Driver Preview Prompt</h3>
                <textarea id="prompt-driver-preview" class="prompt-textarea" rows="12"></textarea>
                <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Variables: {driverName}, {driverNumber}, {team}, {circuit}, {raceContext}</p>
                <div id="saved-driver-preview" class="saved-indicator" style="display: none;">✓ Saved</div>
            </div>

            <div style="margin-bottom: 2rem;">
                <h3 style="color: #ff1e00; margin-bottom: 1rem;">Top 5 Analysis Prompt</h3>
                <textarea id="prompt-top5" class="prompt-textarea" rows="10"></textarea>
                <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Used to analyze all drivers and pick top 5 to watch</p>
                <div id="saved-top5" class="saved-indicator" style="display: none;">✓ Saved</div>
            </div>

            <div style="margin-bottom: 2rem;">
                <h3 style="color: #ff1e00; margin-bottom: 1rem;">Underdog Stories Prompt</h3>
                <textarea id="prompt-underdogs" class="prompt-textarea" rows="10"></textarea>
                <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Used to identify 3 underdog stories</p>
                <div id="saved-underdogs" class="saved-indicator" style="display: none;">✓ Saved</div>
            </div>

            <button class="generate-btn secondary" onclick="resetPromptsToDefault()">
                🔄 Reset to Default Prompts
            </button>
        </div>

        <div class="tabs" id="tabs">
            <button class="tab active" onclick="switchTab(event, 'highlights')">🏆 Top 5 to Watch</button>
            <button class="tab" onclick="switchTab(event, 'underdogs')">🔥 Underdog Stories</button>
            <button class="tab" onclick="switchTab(event, 'all-drivers')">👥 All Drivers</button>
        </div>

        <div class="content-area">
            <div id="highlights-content" class="tab-content">
                <div class="empty-state">
                    <p>Generate previews to see the top 5 drivers to watch this weekend</p>
                </div>
            </div>

            <div id="underdogs-content" class="tab-content" style="display: none;">
                <div class="empty-state">
                    <p>Generate previews to discover the underdog stories</p>
                </div>
            </div>

            <div id="all-drivers-content" class="tab-content" style="display: none;">
                <div class="driver-grid" id="driver-grid">
                    <!-- Driver cards will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Detail Modal -->
    <div id="driver-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-driver-name">Driver Name</h2>
                <button class="modal-close" onclick="closeDriverModal()">×</button>
            </div>
            <div id="modal-driver-content">
                <!-- Driver preview content -->
            </div>
        </div>
    </div>

    <script>
        const drivers2025 = [
            { name: 'Max Verstappen', team: 'Red Bull', number: 1 },
            { name: 'Yuki Tsunoda', team: 'Red Bull', number: 22 },
            { name: 'Lewis Hamilton', team: 'Ferrari', number: 44 },
            { name: 'Charles Leclerc', team: 'Ferrari', number: 16 },
            { name: 'Lando Norris', team: 'McLaren', number: 4 },
            { name: 'Oscar Piastri', team: 'McLaren', number: 81 },
            { name: 'George Russell', team: 'Mercedes', number: 63 },
            { name: 'Kimi Antonelli', team: 'Mercedes', number: 12 },
            { name: 'Fernando Alonso', team: 'Aston Martin', number: 14 },
            { name: 'Lance Stroll', team: 'Aston Martin', number: 18 },
            { name: 'Pierre Gasly', team: 'Alpine', number: 10 },
            { name: 'Franco Colapinto', team: 'Alpine', number: 45 },
            { name: 'Esteban Ocon', team: 'Haas', number: 31 },
            { name: 'Oliver Bearman', team: 'Haas', number: 87 },
            { name: 'Alex Albon', team: 'Williams', number: 23 },
            { name: 'Carlos Sainz', team: 'Williams', number: 55 },
            { name: 'Liam Lawson', team: 'Racing Bulls', number: 30 },
            { name: 'Isack Hadjar', team: 'Racing Bulls', number: 6 },
            { name: 'Nico Hulkenberg', team: 'Sauber', number: 27 },
            { name: 'Gabriel Bortoleto', team: 'Sauber', number: 5 }
        ];

        const defaultPrompts = {
            raceContext: `Provide race weekend context for the {circuit} Grand Prix on {raceDate} in {season}. Include:
- Weather forecast (temperature, rain probability, wind)
- Track characteristics and key corners
- Historical safety car statistics at this circuit
- Strategy considerations (tire compounds, pit stop windows)
- Recent race history at this circuit (last 3 years)
- Any unique challenges this circuit presents

Keep it concise and factual. Format as structured data.`,

            driverPreview: `Write a "what to look for with {driverName}" text for the upcoming F1 {circuit} GP. 

Driver: {driverName} (#{driverNumber})
Team: {team}

Race Context:
{raceContext}

Consider:
- Current form and recent results this season (last 5 races)
- Previous performance at this circuit (if applicable)
- Car setup considerations for this track
- Stakes (championship position, career implications, contract situation)
- Driver strengths and weaknesses relevant to this circuit
- What would be a good/perfect result (qualifying and race)

Provide two versions:
1. TLDR: 2-3 sentences max, punchy and informative
2. FULL: Detailed informational text (150-200 words)

Format as JSON:
{
  "tldr": "...",
  "full": "...",
  "perfect_quali": "P1-P3",
  "perfect_race": "Podium finish",
  "good_quali": "P4-P6",
  "good_race": "Points finish",
  "stakes_level": "high/medium/low",
  "key_strengths": ["strength1", "strength2"],
  "watch_for": "specific thing to watch"
}`,

            top5: `Based on these driver previews and race context, identify the TOP 5 DRIVERS TO WATCH for this race weekend.

Consider:
- Championship stakes (title fight, team battles)
- Pressure situations (contract year, recent struggles/success)
- Current form (hot streak, redemption arc)
- Track-specific advantages (historical performance, driving style match)
- Storylines (rivalries, milestones, team dynamics)

For each driver, provide:
- Driver name
- Position in ranking (1-5)
- 1-2 sentence abstract explaining why they're must-watch
- Link reference to full preview

Return as JSON array:
[
  {
    "rank": 1,
    "driver": "Driver Name",
    "reason": "Compelling 1-2 sentence explanation",
    "stakes": "What's on the line"
  }
]`,

            underdogs: `Identify 3 UNDERDOG STORIES for this race weekend.

An underdog story should feature drivers who:
- Could surprise with performance above expectations
- Have something significant to prove
- Face adversity or a unique opportunity
- Are flying under the radar but could shine
- Have track-specific advantages not widely recognized

For each underdog, provide:
- Driver name
- Story title (catchy, 5-7 words)
- Story description (2-3 sentences explaining the narrative)
- Why they could surprise

Return as JSON array:
[
  {
    "driver": "Driver Name",
    "title": "Catchy story title",
    "story": "2-3 sentence narrative",
    "surprise_factor": "Why they could overperform"
  }
]`
        };

        function createEmptyGeneratedData() {
            return {
                drivers: {},
                top5: [],
                underdogs: [],
                raceContext: '',
                metadata: {
                    circuit: '',
                    date: '',
                    season: '',
                    generatedAt: null
                }
            };
        }

        var generatedData = createEmptyGeneratedData();

        // Initialize
        function init() {
            loadSavedData();
            loadPrompts();
            initializeDriverGrid();
            loadAPISettings();
            
            // Add auto-save for prompts
            ['prompt-race-context', 'prompt-driver-preview', 'prompt-top5', 'prompt-underdogs'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => savePrompt(id));
            });

            // Add auto-save for API settings
            ['api-key', 'model', 'temperature'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveAPISettings);
            });
        }

        function loadSavedData() {
            const saved = localStorage.getItem('f1-preview-data');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    const fresh = createEmptyGeneratedData();

                    generatedData = {
                        ...fresh,
                        ...parsed,
                        metadata: {
                            ...fresh.metadata,
                            ...(parsed.metadata || {})
                        }
                    };
                } catch (err) {
                    console.warn('Failed to parse saved preview data, starting fresh.', err);
                    localStorage.removeItem('f1-preview-data');
                    generatedData = createEmptyGeneratedData();
                }
                
                // Update UI with saved circuit/date
                if (generatedData.metadata.circuit) {
                    document.getElementById('circuit').value = generatedData.metadata.circuit;
                }
                if (generatedData.metadata.date) {
                    document.getElementById('race-date').value = generatedData.metadata.date;
                }
                if (generatedData.metadata.season) {
                    document.getElementById('season').value = generatedData.metadata.season;
                }
                
                // Render saved content
                if (Object.keys(generatedData.drivers).length > 0) {
                    renderAllContent();
                }
            }
        }

        function saveData() {
            generatedData.metadata = {
                circuit: document.getElementById('circuit').value,
                date: document.getElementById('race-date').value,
                season: document.getElementById('season').value,
                generatedAt: new Date().toISOString()
            };
            localStorage.setItem('f1-preview-data', JSON.stringify(generatedData));
        }

        function loadPrompts() {
            const prompts = {
                'prompt-race-context': localStorage.getItem('prompt-race-context') || defaultPrompts.raceContext,
                'prompt-driver-preview': localStorage.getItem('prompt-driver-preview') || defaultPrompts.driverPreview,
                'prompt-top5': localStorage.getItem('prompt-top5') || defaultPrompts.top5,
                'prompt-underdogs': localStorage.getItem('prompt-underdogs') || defaultPrompts.underdogs
            };

            Object.keys(prompts).forEach(id => {
                document.getElementById(id).value = prompts[id];
            });
        }

        function savePrompt(id) {
            const value = document.getElementById(id).value;
            localStorage.setItem(id, value);
            
            const indicator = document.getElementById(`saved-${id.replace('prompt-', '')}`);
            indicator.style.display = 'inline-block';
            setTimeout(() => indicator.style.display = 'none', 2000);
        }

        function resetPromptsToDefault() {
            if (confirm('Reset all prompts to default? This cannot be undone.')) {
                Object.keys(defaultPrompts).forEach(key => {
                    const id = `prompt-${key === 'driverPreview' ? 'driver-preview' : key === 'raceContext' ? 'race-context' : key}`;
                    document.getElementById(id).value = defaultPrompts[key];
                    localStorage.setItem(id, defaultPrompts[key]);
                });
                alert('Prompts reset to default');
            }
        }

        function loadAPISettings() {
            const apiKey = localStorage.getItem('api-key');
            const model = localStorage.getItem('model');
            const temperature = localStorage.getItem('temperature');

            if (apiKey) document.getElementById('api-key').value = apiKey;
            if (model) document.getElementById('model').value = model;
            if (temperature) document.getElementById('temperature').value = temperature;
        }

        function saveAPISettings() {
            localStorage.setItem('api-key', document.getElementById('api-key').value);
            localStorage.setItem('model', document.getElementById('model').value);
            localStorage.setItem('temperature', document.getElementById('temperature').value);
        }

        function clearAllData() {
            if (confirm('Clear all saved data? This will remove all generated previews and you will need to regenerate them.')) {
                localStorage.removeItem('f1-preview-data');
                generatedData = createEmptyGeneratedData();
                initializeDriverGrid();
                document.getElementById('highlights-content').innerHTML = '<div class="empty-state"><p>Generate previews to see the top 5 drivers to watch this weekend</p></div>';
                document.getElementById('underdogs-content').innerHTML = '<div class="empty-state"><p>Generate previews to discover the underdog stories</p></div>';
                alert('All data cleared');
            }
        }

        function togglePromptEditor() {
            const editor = document.getElementById('prompt-editor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        }

        function initializeDriverGrid() {
            const grid = document.getElementById('driver-grid');
            grid.innerHTML = drivers2025.map(driver => {
                const hasPreview = generatedData.drivers[driver.name];
                const statusClass = hasPreview ? 'generated' : '';
                const statusBadge = hasPreview ? '✓' : '';
                
                return `
                    <div class="driver-card ${statusClass}" id="card-${driver.number}" onclick="viewDriver('${driver.name}')">
                        <div class="status-badge">${statusBadge}</div>
                        <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">#${driver.number}</div>
                        <div style="font-size: 1.1rem; font-weight: 600;">${driver.name}</div>
                        <div style="color: #999; margin-top: 0.3rem;">${driver.team}</div>
                    </div>
                `;
            }).join('');
        }

        function switchTab(evt, tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            }

            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

            const target = document.getElementById(`${tab}-content`);
            if (target) {
                target.style.display = 'block';
            }
        }

        async function generateAllPreviews() {
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model').value;
            const circuit = document.getElementById('circuit').value;
            const raceDate = document.getElementById('race-date').value;
            const season = document.getElementById('season').value;
            const temperature = parseFloat(document.getElementById('temperature').value);

            if (!apiKey) {
                alert('Please enter your OpenAI API key');
                return;
            }

            const btn = document.querySelector('.generate-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');

            btn.disabled = true;
            progressContainer.style.display = 'block';

            const total = drivers2025.length + 2; // drivers + top5 + underdogs
            let completed = 0;

            try {
                // Generate weather/circuit context first
                progressText.textContent = 'Fetching race weekend context...';
                generatedData.raceContext = await generateRaceContext(apiKey, model, circuit, raceDate, season, temperature);
                
                // Generate all driver previews in parallel (async)
                progressText.textContent = 'Generating all driver previews in parallel...';
                
                const driverPromises = drivers2025.map(async (driver) => {
                    const card = document.getElementById(`card-${driver.number}`);
                    card.classList.add('loading');
                    card.querySelector('.status-badge').textContent = '⏳';
                    
                    try {
                        const preview = await generateDriverPreview(apiKey, model, driver, circuit, generatedData.raceContext, temperature);
                        generatedData.drivers[driver.name] = preview;
                        
                        card.classList.remove('loading');
                        card.classList.add('generated');
                        card.querySelector('.status-badge').textContent = '✓';
                        
                        completed++;
                        const percent = Math.round((completed / total) * 100);
                        progressFill.style.width = `${percent}%`;
                        progressFill.textContent = `${percent}%`;
                        progressText.textContent = `Generated ${completed} of ${drivers2025.length} drivers...`;
                        
                        return preview;
                    } catch (error) {
                        card.classList.remove('loading');
                        card.querySelector('.status-badge').textContent = '❌';
                        console.error(`Error generating preview for ${driver.name}:`, error);
                        return null;
                    }
                });

                await Promise.all(driverPromises);

                // Generate top 5 to watch
                progressText.textContent = 'Analyzing top 5 drivers to watch...';
                generatedData.top5 = await generateTop5(apiKey, model, generatedData.drivers, generatedData.raceContext, temperature);
                completed++;
                progressFill.style.width = `${Math.round((completed / total) * 100)}%`;

                // Generate underdog stories
                progressText.textContent = 'Identifying underdog stories...';
                generatedData.underdogs = await generateUnderdogs(apiKey, model, generatedData.drivers, generatedData.raceContext, temperature);
                completed++;
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';

                progressText.textContent = 'Complete! Saving and rendering...';
                
                // Save to localStorage
                saveData();
                
                // Render all content
                renderAllContent();
                
                setTimeout(() => {
                    btn.disabled = false;
                    progressContainer.style.display = 'none';
                    alert('All previews generated and saved successfully!');
                }, 1000);

            } catch (error) {
                console.error('Generation error:', error);
                btn.disabled = false;
                progressContainer.style.display = 'none';
                alert('Error generating previews: ' + error.message);
            }
        }

        function renderAllContent() {
            renderHighlights();
            renderUnderdogs();
            initializeDriverGrid();
        }

        async function generateRaceContext(apiKey, model, circuit, raceDate, season, temperature) {
            const promptTemplate = document.getElementById('prompt-race-context').value;
            const prompt = promptTemplate
                .replace('{circuit}', circuit)
                .replace('{raceDate}', raceDate)
                .replace('{season}', season);

            return await callOpenAI(apiKey, model, prompt, temperature, { responseFormat: { type: 'json_object' } });
        }

        async function generateDriverPreview(apiKey, model, driver, circuit, raceContext, temperature) {
            const promptTemplate = document.getElementById('prompt-driver-preview').value;
            const prompt = promptTemplate
                .replace('{driverName}', driver.name)
                .replace('{driverNumber}', driver.number)
                .replace('{team}', driver.team)
                .replace('{circuit}', circuit)
                .replace('{raceContext}', raceContext);

            const response = await callOpenAI(apiKey, model, prompt, temperature, { responseFormat: { type: 'json_object' } });
            
            // Try to parse as JSON, fallback to text
            try {
                return typeof response === 'string' ? JSON.parse(response) : response;
            } catch {
                return {
                    tldr: response.substring(0, 200),
                    full: response,
                    perfect_quali: 'TBD',
                    perfect_race: 'TBD',
                    stakes_level: 'medium'
                };
            }
        }

        async function generateTop5(apiKey, model, driverPreviews, raceContext, temperature) {
            const promptTemplate = document.getElementById('prompt-top5').value;
            const driversData = JSON.stringify(driverPreviews, null, 2);
            const prompt = promptTemplate + '\n\nDriver Previews:\n' + driversData + '\n\nRace Context:\n' + raceContext;

            const response = await callOpenAI(apiKey, model, prompt, temperature, { responseFormat: { type: 'json_object' } });
            
            try {
                return typeof response === 'string' ? JSON.parse(response) : response;
            } catch {
                return [];
            }
        }

        async function generateUnderdogs(apiKey, model, driverPreviews, raceContext, temperature) {
            const promptTemplate = document.getElementById('prompt-underdogs').value;
            const driversData = JSON.stringify(driverPreviews, null, 2);
            const prompt = promptTemplate + '\n\nDriver Previews:\n' + driversData + '\n\nRace Context:\n' + raceContext;

            const response = await callOpenAI(apiKey, model, prompt, temperature, { responseFormat: { type: 'json_object' } });
            
            try {
                return typeof response === 'string' ? JSON.parse(response) : response;
            } catch {
                return [];
            }
        }

        async function callOpenAI(apiKey, model, prompt, temperature, options = {}) {
            // Replace this with actual OpenAI API call
            const requestBody = {
                model: model,
                temperature: temperature,
                input: prompt
            };

            if (options.responseFormat) {
                const { type, ...formatOptions } = options.responseFormat;

                if (type === 'json_object') {
                    requestBody.text = {
                        format: 'json_schema',
                        schema: {
                            name: 'json_response',
                            schema: {
                                type: 'object',
                                additionalProperties: true
                            }
                        }
                    };
                } else if (type === 'json_schema') {
                    const schemaDefinition = formatOptions.schema || formatOptions.json_schema;

                    requestBody.text = {
                        format: 'json_schema',
                        ...(schemaDefinition ? { schema: schemaDefinition } : {})
                    };
                } else {
                    requestBody.text = {
                        format: type,
                        ...formatOptions
                    };
                }
            }

            const response = await fetch('https://api.openai.com/v1/responses', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
                const message = data?.error?.message || response.statusText || 'Unknown error';
                throw new Error(`API Error: ${response.status} ${message}`);
            }
            
            if (Array.isArray(data.output)) {
                const messageChunks = data.output
                    .filter(item => item.type === 'message' && Array.isArray(item.content))
                    .flatMap(item => item.content)
                    .filter(part => part.type === 'output_text' && typeof part.text === 'string')
                    .map(part => part.text.trim())
                    .filter(Boolean);

                if (messageChunks.length > 0) {
                    return messageChunks.join('\n');
                }
            }

            if (Array.isArray(data.choices) && data.choices.length > 0) {
                return data.choices[0].message?.content || data.choices[0].text;
            }

            if (typeof data.output_text === 'string') {
                return data.output_text;
            }

            throw new Error('Unexpected API response format');
        }

        function renderHighlights() {
            const content = document.getElementById('highlights-content');
            
            if (!generatedData.top5 || generatedData.top5.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>Generate previews to see the top 5 drivers to watch this weekend</p></div>';
                return;
            }

            content.innerHTML = `
                <div class="highlight-section">
                    <h3>🏆 Top 5 Drivers to Watch - ${document.getElementById('circuit').value.toUpperCase()} GP ${document.getElementById('season').value}</h3>
                    ${generatedData.top5.map((item, i) => `
                        <div class="top-driver-item">
                            <h4>#${item.rank || i + 1} ${item.driver}</h4>
                            <p><strong>Why watch:</strong> ${item.reason}</p>
                            ${item.stakes ? `<p style="color: #ff1e00; margin-top: 0.5rem;"><strong>Stakes:</strong> ${item.stakes}</p>` : ''}
                            <a href="#" onclick="viewDriver('${item.driver}'); return false;" style="color: #e10600; margin-top: 0.5rem; display: inline-block;">→ View full preview</a>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderUnderdogs() {
            const content = document.getElementById('underdogs-content');
            
            if (!generatedData.underdogs || generatedData.underdogs.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>Generate previews to discover the underdog stories</p></div>';
                return;
            }

            content.innerHTML = `
                <div class="highlight-section">
                    <h3>🔥 Underdog Stories - ${document.getElementById('circuit').value.toUpperCase()} GP ${document.getElementById('season').value}</h3>
                    ${generatedData.underdogs.map((item, i) => `
                        <div class="top-driver-item">
                            <h4>${item.title || `Story ${i + 1}: ${item.driver}`}</h4>
                            <p>${item.story}</p>
                            ${item.surprise_factor ? `<p style="color: #00ff88; margin-top: 0.5rem;"><strong>Surprise Factor:</strong> ${item.surprise_factor}</p>` : ''}
                            <a href="#" onclick="viewDriver('${item.driver}'); return false;" style="color: #e10600; margin-top: 0.5rem; display: inline-block;">→ View full preview</a>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function viewDriver(driverName) {
            const preview = generatedData.drivers[driverName];
            if (!preview) {
                alert('Preview not yet generated for ' + driverName);
                return;
            }

            const driver = drivers2025.find(d => d.name === driverName);
            const modal = document.getElementById('driver-modal');
            const modalName = document.getElementById('modal-driver-name');
            const modalContent = document.getElementById('modal-driver-content');

            modalName.textContent = `${driverName} - #${driver.number} ${driver.team}`;
            
            modalContent.innerHTML = `
                <div class="driver-preview">
                    <h3>TL;DR</h3>
                    <div class="tldr">${preview.tldr}</div>
                    
                    <h3 style="margin-top: 1.5rem;">Full Analysis</h3>
                    <div class="full-text">${preview.full}</div>
                    
                    <div style="margin-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="background: rgba(0, 255, 0, 0.1); padding: 1rem; border-radius: 6px;">
                            <strong style="color: #00ff88;">Perfect Weekend:</strong><br>
                            Quali: ${preview.perfect_quali || 'N/A'}<br>
                            Race: ${preview.perfect_race || 'N/A'}
                        </div>
                        <div style="background: rgba(255, 165, 0, 0.1); padding: 1rem; border-radius: 6px;">
                            <strong style="color: #ffaa00;">Good Weekend:</strong><br>
                            Quali: ${preview.good_quali || 'N/A'}<br>
                            Race: ${preview.good_race || 'N/A'}
                        </div>
                    </div>
                    
                    ${preview.key_strengths ? `
                        <div style="margin-top: 1rem;">
                            <strong>Key Strengths:</strong> ${preview.key_strengths.join(', ')}
                        </div>
                    ` : ''}
                    
                    ${preview.watch_for ? `
                        <div style="margin-top: 1rem; background: rgba(225, 6, 0, 0.1); padding: 1rem; border-radius: 6px;">
                            <strong style="color: #ff1e00;">🔍 Watch For:</strong> ${preview.watch_for}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1rem; text-align: center; color: #666;">
                        Stakes Level: <span style="color: ${preview.stakes_level === 'high' ? '#ff0000' : preview.stakes_level === 'medium' ? '#ffaa00' : '#00ff88'}; text-transform: uppercase; font-weight: bold;">${preview.stakes_level || 'Medium'}</span>
                    </div>
                </div>
            `;

            modal.style.display = 'block';
        }

        function closeDriverModal() {
            document.getElementById('driver-modal').style.display = 'none';
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('driver-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
